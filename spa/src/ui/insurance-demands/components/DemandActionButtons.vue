<template>
    <div>
        <!-- Extract Data Button (Only shown when authorized) -->
        <ActionButton
            v-if="isAuthorized"
            type="play"
            color="sky"
            :size="size"
            :saving="isExtractingDataComputed"
            :label="extractDataLabel"
            :class="buttonItemClass"
            @click="handleExtractData"
        />

        <!-- Write Medical Summary Button (Only shown when authorized) -->
        <ActionButton
            v-if="isAuthorized"
            type="edit"
            color="teal"
            :size="size"
            :saving="isWritingMedicalSummaryComputed"
            :disabled="!canWriteMedicalSummary"
            :label="writeMedicalSummaryLabel"
            :tooltip="writeMedicalSummaryTooltip"
            :class="buttonItemClass"
            @click="showInstructionTemplateSelector = true"
        />

        <!-- Write Demand Letter Button (Only shown when authorized) -->
        <ActionButton
            v-if="isAuthorized"
            type="document"
            color="green"
            :size="size"
            :saving="isWritingDemandLetterComputed"
            :disabled="!canWriteDemandLetter"
            :label="writeDemandLetterLabel"
            :tooltip="writeDemandLetterTooltip"
            :class="buttonItemClass"
            @click="showDemandTemplateSelector = true"
        />

        <!-- Instruction Selector Dialog -->
        <InstructionTemplateSelector
            v-if="showInstructionTemplateSelector"
            :demand="demand"
            @confirm="handleWriteMedicalSummaryWithTemplate"
            @close="showInstructionTemplateSelector = false"
        />

        <!-- Demand Template Selector Dialog -->
        <DemandTemplateSelector
            v-if="showDemandTemplateSelector"
            :demand="demand"
            @confirm="handleWriteDemandLetterWithTemplate"
            @close="showDemandTemplateSelector = false"
        />
    </div>
</template>

<script setup lang="ts">
import { DemandTemplateSelector, InstructionTemplateSelector } from "@/ui/demand-templates/components";
import { ActionButton } from "quasar-ui-danx";
import { computed, ref } from "vue";
import { useGoogleDocsAuth } from "../../shared/composables/useGoogleDocsAuth";
import type { UiDemand } from "../../shared/types";
import { useDemands, isWorkflowActive, isWorkflowCompleted } from "../composables";

const props = withDefaults(defineProps<{
    demand: UiDemand;
    size?: "xs" | "sm" | "md" | "lg" | "xl";
    buttonClass?: string;
    buttonItemClass?: string;
    extractDataLabel?: string;
    writeMedicalSummaryLabel?: string;
    writeDemandLetterLabel?: string;
}>(), {
    size: "md",
    buttonItemClass: "",
    extractDataLabel: "Extract Data",
    writeMedicalSummaryLabel: "Write Medical Summary",
    writeDemandLetterLabel: "Write Demand Letter"
});

// Import composable for demand actions
const { extractData, writeMedicalSummary, writeDemandLetter } = useDemands();
const { isAuthorized } = useGoogleDocsAuth();

// Local state for optimistic UI during API calls
const isExtractingData = ref(false);
const isWritingMedicalSummary = ref(false);
const isWritingDemandLetter = ref(false);
const showInstructionTemplateSelector = ref(false);
const showDemandTemplateSelector = ref(false);

// Computed loading states based on workflow_run.status (single source of truth)
// Local state is only used for optimistic UI during the API call itself
const isExtractingDataComputed = computed(() => {
	return isWorkflowActive(props.demand?.extract_data_workflow_run) || isExtractingData.value;
});

const isWritingMedicalSummaryComputed = computed(() => {
	return isWorkflowActive(props.demand?.write_medical_summary_workflow_run) || isWritingMedicalSummary.value;
});

const isWritingDemandLetterComputed = computed(() => {
	return isWorkflowActive(props.demand?.write_demand_letter_workflow_run) || isWritingDemandLetter.value;
});

// Calculate disabled state based on workflow completion (single source of truth)
const canWriteMedicalSummary = computed(() => {
    // Medical Summary can be written only when Extract Data workflow is completed
    return isWorkflowCompleted(props.demand?.extract_data_workflow_run);
});

const writeMedicalSummaryTooltip = computed(() => {
    if (!canWriteMedicalSummary.value) {
        const extractDataRun = props.demand?.extract_data_workflow_run;

        if (!extractDataRun) {
            return "Extract data first before writing medical summary";
        }

        if (extractDataRun.status === "Failed") {
            return "Extract data failed - please retry extraction before writing medical summary";
        }

        if (extractDataRun.status === "Stopped") {
            return "Extract data was stopped - please resume or restart before writing medical summary";
        }

        if (isWorkflowActive(extractDataRun)) {
            return "Extract data is currently running - please wait for completion";
        }

        return "Extract data first before writing medical summary";
    }
    return undefined;
});

// Calculate disabled state based on workflow completion (single source of truth)
const canWriteDemandLetter = computed(() => {
    // Demand Letter can be written only when Medical Summary workflow is completed
    return isWorkflowCompleted(props.demand?.write_medical_summary_workflow_run);
});

const writeDemandLetterTooltip = computed(() => {
    if (!canWriteDemandLetter.value) {
        const medicalSummaryRun = props.demand?.write_medical_summary_workflow_run;

        if (!medicalSummaryRun) {
            return "Write medical summary first before writing demand letter";
        }

        if (medicalSummaryRun.status === "Failed") {
            return "Medical summary failed - please retry before writing demand letter";
        }

        if (medicalSummaryRun.status === "Stopped") {
            return "Medical summary was stopped - please resume or restart before writing demand letter";
        }

        if (isWorkflowActive(medicalSummaryRun)) {
            return "Medical summary is currently running - please wait for completion";
        }

        return "Write medical summary first before writing demand letter";
    }
    return undefined;
});

// Action handlers
const handleExtractData = async () => {
    try {
        isExtractingData.value = true;
        await extractData(props.demand);
    } finally {
        isExtractingData.value = false;
    }
};

const handleWriteMedicalSummaryWithTemplate = async (instructionTemplate: any, instructions: string) => {
    try {
        isWritingMedicalSummary.value = true;
        showInstructionTemplateSelector.value = false; // Close the modal
        await writeMedicalSummary(props.demand, instructionTemplate?.id, instructions);
    } finally {
        isWritingMedicalSummary.value = false;
    }
};

const handleWriteDemandLetterWithTemplate = async (template: any, instructions: string) => {
    try {
        isWritingDemandLetter.value = true;
        showDemandTemplateSelector.value = false; // Close the modal
        await writeDemandLetter(props.demand, template.id, instructions);
    } finally {
        isWritingDemandLetter.value = false;
    }
};

</script>
