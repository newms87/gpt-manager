<template>
	<div class="node-header">
		<div class="flex flex-nowrap items-center space-x-2 h-8">
			<div class="flex-grow flex items-center flex-nowrap space-x-1">
				<ShowTaskProcessesButton v-if="taskRun" :task-run="taskRun" class="bg-sky-950" size="xs" />
				<ActionButton
					v-if="isRunning"
					type="stop"
					:disabled="!isRunning"
					:action="stopAction"
					:target="taskRun"
					color="red"
					tooltip="Stop task"
					size="xs"
				/>
				<ActionButton
					v-else-if="isStopped"
					type="play"
					:action="resumeAction"
					:target="taskRun"
					color="green-invert"
					tooltip="Continue running task"
					size="xs"
				/>
				<ActionButton
					v-if="canBeRestarted"
					type="refresh"
					:action="restartAction"
					:target="taskRun"
					color="sky"
					tooltip="Restart task"
					size="xs"
				/>
			</div>
			<template v-if="!isWorkflowRunning">
				<ActionButton
					type="copy"
					color="blue"
					:disabled="temporary"
					size="xs"
					tooltip="Copy Task"
					@click.stop="$emit('copy')"
				/>
				<ActionButton
					type="edit"
					color="sky"
					:disabled="temporary"
					size="xs"
					tooltip="Edit Task"
					@click.stop="$emit('edit')"
				/>
				<ActionButton
					type="trash"
					color="red"
					:disabled="temporary"
					size="xs"
					tooltip="Remove Node From Workflow"
					@click.stop="$emit('remove')"
				/>
			</template>
		</div>
	</div>
</template>

<script setup lang="ts">
import { dxTaskRun } from "@/components/Modules/TaskDefinitions/TaskRuns/config";
import { activeTaskWorkflowRun, refreshActiveTaskWorkflowRun } from "@/components/Modules/TaskWorkflows/store";
import ShowTaskProcessesButton from "@/components/Modules/WorkflowCanvas/ShowTaskProcessesButton";
import { TaskRun } from "@/types";
import { ActionButton } from "quasar-ui-danx";
import { computed } from "vue";

defineEmits<{
	edit: void;
	remove: void;
	copy: void;
}>();
const props = defineProps<{
	taskRun?: TaskRun;
	temporary?: boolean;
	loading?: boolean;
}>();

const isWorkflowRunning = computed(() => ["Running"].includes(activeTaskWorkflowRun.value?.status));

const restartAction = dxTaskRun.getAction("restart", { onFinish: refreshActiveTaskWorkflowRun });
const resumeAction = dxTaskRun.getAction("resume", { onFinish: refreshActiveTaskWorkflowRun });
const stopAction = dxTaskRun.getAction("stop");
const isStopped = computed(() => ["Stopped"].includes(props.taskRun?.status));
const canBeRestarted = computed(() => ["Pending", "Stopped", "Failed", "Completed"].includes(props.taskRun?.status));
const isRunning = computed(() => ["Running"].includes(props.taskRun?.status));
</script>
