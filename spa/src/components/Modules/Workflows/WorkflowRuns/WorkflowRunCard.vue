<template>
	<QCard class="bg-slate-800 text-slate-300 rounded overflow-hidden">
		<div class="flex items-center justify-between">
			<div class="flex-grow cursor-pointer py-4 px-3">
				<a @click="$router.push({name: 'workflows', params: {id: workflowRun.workflow_id}})">
					{{ workflowRun.workflow_name }} ({{ workflowRun.id }})
				</a>
			</div>
			<ShowHideButton
				v-model="showArtifacts"
				:label="artifactCount + ' Artifacts'"
				class="bg-sky-800 text-sky-200 mx-2"
			/>
			<ShowHideButton
				v-model="showJobs"
				:label="jobCount + ' Jobs'"
				class="bg-slate-600 text-slate-200 mx-2"
			/>
			<div class="mx-2">
				<ElapsedTimePill
					timer-class="bg-slate-900 font-bold rounded-lg text-xs w-32 text-center py-2"
					:start="workflowRun.started_at"
					:end="workflowRun.failed_at || workflowRun.completed_at"
				/>
			</div>
			<div
				class="px-4 py-1.5 rounded-lg mx-2 w-28 text-center"
				:class="WORKFLOW_STATUS.resolve(workflowRun.status).classPrimary"
			>
				{{ workflowRun.status }}
			</div>
			<div class="mx-2">
				<AiTokenUsageButton :usage="workflowRun.usage" />
			</div>
			<div class="mr-1">
				<ActionButton
					type="trash"
					:action="removeWorkflowRunAction"
					:target="workflowRun"
					class="p-4"
					@success="$emit('remove')"
				/>
			</div>
		</div>
		<div class="flex items-stretch">
			<div v-if="showArtifacts" class="p-3">
				<ArtifactCard
					v-for="artifact in workflowRun.artifacts"
					:key="artifact.id"
					:artifact="artifact"
					class="my-3"
				/>
			</div>
		</div>
		<div v-if="showJobs" class="p-3">
			<WorkflowJobRunCard
				v-for="job in workflowRun.workflowJobRuns"
				:key="job.id"
				:job-run="job"
				class="mt-3"
				:workflow-run="workflowRun"
			/>
		</div>
	</QCard>
</template>
<script setup lang="ts">
import ArtifactCard from "@/components/Modules/Artifacts/ArtifactCard";
import { WORKFLOW_STATUS } from "@/components/Modules/Workflows/consts/workflows";
import { WorkflowInputController } from "@/components/Modules/Workflows/WorkflowInputs/workflowInputControls";
import { getAction } from "@/components/Modules/Workflows/workflowRunActions";
import ElapsedTimePill from "@/components/Modules/Workflows/WorkflowRuns/ElapsedTimePill";
import WorkflowJobRunCard from "@/components/Modules/Workflows/WorkflowRuns/WorkflowJobRunCard";
import { ShowHideButton } from "@/components/Shared";
import ActionButton from "@/components/Shared/Buttons/ActionButton";
import AiTokenUsageButton from "@/components/Shared/Buttons/AiTokenUsageButton";
import { WorkflowRun } from "@/types/workflows";
import { computed, ref } from "vue";

defineEmits(["remove"]);
const props = defineProps<{
	workflowRun: WorkflowRun;
}>();

const artifactCount = computed(() => props.workflowRun.artifacts?.length);
const jobCount = computed(() => props.workflowRun.workflowJobRuns?.length);
const showArtifacts = ref(false);
const showJobs = ref(false);

const removeWorkflowRunAction = getAction("delete");
removeWorkflowRunAction.onFinish = WorkflowInputController.getActiveItemDetails;
</script>
